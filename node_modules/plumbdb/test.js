var it = require('it-is')
var plumbdb = require('./index')
var async = require('async')

function setup(cb) {
  var instance = plumbdb('test', function(err, db) {
    cb(err, instance)
  })
}

function teardown(instance, cb) {
  instance.destroy(cb)
}

function assert(test) {
  return function(cb) {
    setup(function(err, instance) {
      function done(result) {
        teardown(instance, function(destroyErr) {
          if (destroyErr) console.log("Destroy Error", destroyErr)
          cb(false, result)
        })
      }
      try {
        test(instance, done)
      } catch(e) {
        done(e)
      }
    })
  }
}

var tests = {
  _store: assert(function(p, cb) {
    p._store({'hello': 'world'}, function(err, doc) {
      cb(!doc._rev && !doc._stamp && !doc._id)
    })
  }),
  update: assert(function(p, cb) {
    p._store({'hello': 'world'}, function(err, doc) {
      doc.foo = "bar"
      p._store(doc, function(err, edited) {
        p.get(doc._id, function(err, retrieved) {
          cb(JSON.stringify(edited) !== JSON.stringify(retrieved))
        })
      })
    })
  }),
  get: assert(function(p, cb) {
    p._store({'hello': 'get'}, function(err, doc) {
      p.get(doc._id, function(err, stored) {
        cb(JSON.stringify(doc) !== JSON.stringify(stored))
      })
    })
  }),
  updateRev: assert(function(p, cb) {
    p._store({'hello': 'update'}, function(err, doc) {
      doc.foo = "bar"
      p._store(doc, function(err, updated) {
        cb(!(updated._rev > doc._rev))
      })
    })
  }),
  existingRev: assert(function(p, cb) {
    var doc = {
      hello: 'update',
      foo: 'bar',
      _id: 'ea7eb9fb-998f-4210-ab1b-8463033913c4',
      _stamp: '1339875060007344'
    }
    doc._rev = '2-' + p._hash(doc)
    p._store(doc, function(err, stored) {
      cb(doc._rev !== stored._rev)
    })
  }),
  keyStream: assert(function(p, cb) {
    p._store({'_id': 'hello'}, function(err, doc) {
      p._store({'_id': 'goodbye'}, function(err, doc) {
        var query = []
        var ok = true
        p.keyStream('h')
          .on('data', function(key, doc) { query.push(doc) })
          .on('error', function(err) {
            console.log('error', err)
            ok = false
          })
          .on('end', function() {
            if (!ok) return cb(true)
            cb(query.length !== 1)
          })
      })
    })
    
  }),
  rangeStream: assert(function(p, cb) {
    p._store({'_id': 'a'}, function(err, doc) {
      p._store({'_id': 'b'}, function(err, doc) {
        var query = []
        var ok = true
        p.rangeStream('a', 'z')
          .on('data', function(key, doc) { query.push(doc) })
          .on('error', function(err) {
            console.log('error', err)
            ok = false
          })
          .on('end', function() {
            if (!ok) return cb(true)
            cb(query.length !== 2)
          })
      })
    })
    
  })
}

console.log('running tests...')
async.series(tests, function(err, results) {
  Object.keys(results).forEach(function(test) {
    var result = results[test]
    console.log(test, result ? 'FAIL ' + result : 'PASS')
  })
})